# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Account.API CI

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

permissions:
    id-token: write
    contents: read
    checks: write

jobs:
    build:

        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4
        - name: Setup .NET
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: 8.0.x
        - name: Restore dependencies
          run: dotnet restore
          working-directory: src/
        - name: Build
          run: dotnet build --no-restore
          working-directory: src/
        - name: Test
          run: dotnet test --no-build --verbosity normal --logger "trx"
          working-directory: src/        
        - name: Test Report
          uses: dorny/test-reporter@v1      
          if: always()
          with:
            name: Summary Tests
            path: "src/**/**/*.trx"
            reporter: dotnet-trx
            fail-on-error: true
        - name: Generate test summary
            run: |
              PASSED=$(grep -oP '(?<=Passed: )\d+' src/**/**/*.trx | awk '{s+=$1} END {print s}')
              FAILED=$(grep -oP '(?<=Failed: )\d+' src/**/**/*.trx | awk '{s+=$1} END {print s}')
              echo "PASSED=$PASSED" >> $GITHUB_ENV
              echo "FAILED=$FAILED" >> $GITHUB_ENV

      - name: Upload test summary badge
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: "src/test-summary.json"
      
